<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>V2rayNG_Ghavi - جمع‌کننده کانفیگ V2Ray</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800&display=swap');

  :root{
    --bg-color:#010409;--card-bg-color:#0d1117;--border-color:rgba(255,255,255,.1);
    --text-color:#e6edf3;--text-secondary-color:#7d8590;--accent-color:#2f81f7;
    --success-color:#238636;--warning-color:#f59e0b;--danger-color:#da3633;
    --glow-color:rgba(47,129,247,.7);
  }
  *{font-family:'Vazirmatn',sans-serif}
  body{background:var(--bg-color);color:var(--text-color);overflow-x:hidden}
  .proxy-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(370px,1fr));gap:24px}
  .proxy-card{background:var(--card-bg-color);border:1px solid var(--border-color);border-radius:12px;padding:24px;position:relative;overflow:hidden;transition:transform .3s,box-shadow .3s,border-color .3s}
  .proxy-card::before{content:"";position:absolute;inset:0;border-radius:12px;background:radial-gradient(600px circle at var(--mouse-x) var(--mouse-y),var(--glow-color),transparent 40%);opacity:0;transition:opacity .4s;z-index:0}
  .proxy-card:hover::before{opacity:.1}
  .proxy-card:hover{transform:translateY(-5px);box-shadow:0 10px 30px rgba(0,0,0,.3);border-color:rgba(47,129,247,.4)}
  .card-content{position:relative;z-index:1}
  .btn{background:rgba(255,255,255,.05);color:var(--text-color);border:1px solid var(--border-color);border-radius:8px;font-weight:600;transition:.2s;cursor:pointer;position:relative;overflow:hidden}
  .btn:hover{background:rgba(255,255,255,.1);border-color:var(--accent-color);color:#fff}
  .btn-primary{background:var(--accent-color);border-color:var(--accent-color);color:#fff}
  .btn-primary:hover{background:#1f6feb;box-shadow:0 0 15px rgba(47,129,247,.5)}
  .btn-success{background:var(--success-color);border-color:var(--success-color);color:#fff}
  .btn-success:hover{background:#2ea043;box-shadow:0 0 15px rgba(35,134,54,.5)}
  .status-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:500;background:rgba(0,0,0,.3);border:1px solid transparent}
  .status-good{color:#3fb950;border-color:#3fb950}
  .status-medium{color:#d29922;border-color:#d29922}
  .status-bad{color:#f85149;border-color:#f85149}
  .status-unknown{color:var(--text-secondary-color);border-color:var(--text-secondary-color)}
  .pulsing-dot{animation:pulse 2s infinite}
  @keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(63,185,80,.7)}50%{box-shadow:0 0 0 8px rgba(63,185,80,0)}}
  .loading-spinner{width:20px;height:20px;border:2px solid var(--border-color);border-radius:50%;border-top-color:var(--accent-color);animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .fade-in-up{animation:fadeInUp .6s ease-out forwards;opacity:0}
  @keyframes fadeInUp{from{opacity:0;transform:translateY(25px)}to{opacity:1;transform:translateY(0)}}
  .welcome-modal-overlay{position:fixed;inset:0;background:rgba(1,4,9,.8);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);z-index:200;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .4s;padding:1rem}
  .welcome-modal-overlay:not(.hidden){opacity:1}
  .welcome-modal-content{background:linear-gradient(145deg,var(--card-bg-color),#010409);border:1px solid var(--border-color);border-radius:16px;padding:30px 40px;width:100%;max-width:500px;text-align:center;position:relative;box-shadow:0 0 50px rgba(47,129,247,.2),0 0 0 1px rgba(47,129,247,.2);transform:scale(.9) translateY(20px);opacity:0;transition:transform .4s cubic-bezier(.23,1,.32,1),opacity .4s}
  .welcome-modal-overlay:not(.hidden) .welcome-modal-content{transform:scale(1) translateY(0);opacity:1}
  .welcome-modal-close{position:absolute;top:10px;left:15px;background:none;border:none;color:var(--text-secondary-color);font-size:30px;cursor:pointer;transition:color .2s,transform .2s;line-height:1}
  .welcome-modal-close:hover{color:var(--text-color);transform:rotate(90deg)}
  .welcome-modal-icon{width:100px;height:100px;background:linear-gradient(135deg,#2f81f7 0%,#238636 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;box-shadow:0 0 20px rgba(47,129,247,.5);animation:pulse 2s infinite;border:3px solid rgba(255,255,255,.1)}
  .welcome-modal-icon i{font-size:40px;color:#fff}
  .welcome-modal-title{font-size:26px;font-weight:800;color:var(--text-color);margin-bottom:12px}
  .welcome-modal-text{font-size:16px;color:var(--text-secondary-color);margin-bottom:24px;max-width:350px;margin-inline:auto}
  .welcome-modal-link{display:inline-block;background:var(--accent-color);color:#fff;padding:12px 24px;border-radius:8px;font-weight:600;text-decoration:none;transition:.2s}
  .welcome-modal-link:hover{background:#1f6feb;box-shadow:0 0 20px rgba(47,129,247,.6);transform:translateY(-2px)}
  .hidden{display:none !important}
  @media (max-width:768px){.proxy-grid{grid-template-columns:1fr}}
  ::-webkit-scrollbar{width:8px}
  ::-webkit-scrollbar-track{background:var(--bg-color)}
  ::-webkit-scrollbar-thumb{background:#21262d;border-radius:4px;border:1px solid #30363d}
</style>
</head>
<body>

<!-- خوش‌آمدگویی -->
<div id="welcomeModal" class="welcome-modal-overlay hidden">
  <div class="welcome-modal-content">
    <button id="closeWelcomeModal" class="welcome-modal-close">&times;</button>
    <div class="welcome-modal-icon"><i class="fa-solid fa-shield-virus"></i></div>
    <h2 class="welcome-modal-title">به V2rayNG_Ghavi خوش آمدید!</h2>
    <p class="welcome-modal-text">نسل جدید کانفیگ‌های امن و پرسرعت V2Ray</p>
    <a href="https://t.me/V2rayNG_Ghavi" target="_blank" rel="noopener" class="welcome-modal-link">
      <i class="fa-brands fa-telegram ml-2"></i> عضویت در کانال تلگرام
    </a>
  </div>
</div>

<main class="container mx-auto px-4 py-8 md:py-12 relative z-10">
  <header class="text-center mb-12 fade-in-up">
    <div class="inline-block p-4 bg-gray-900/50 rounded-full mb-6 border border-gray-800 transition hover:scale-105 hover:shadow-2xl hover:shadow-sky-500/20">
      <i class="fa-solid fa-shield-virus text-4xl text-white"></i>
    </div>
    <h1 class="text-4xl md:text-5xl font-extrabold text-white mb-4 bg-clip-text text-transparent bg-gradient-to-r from-sky-400 to-cyan-300">V2rayNG_Ghavi</h1>
    <p class="text-lg md:text-xl text-slate-400 max-w-2xl mx-auto">نسل جدید دسترسی به کانفیگ‌های امن و پرسرعت V2Ray</p>
  </header>

  <section id="control-panel" class="proxy-card p-6 mb-8 fade-in-up" style="animation-delay:.2s;">
    <div class="card-content">
      <div class="flex flex-col md:flex-row gap-6 items-center justify-between">
        <button id="refreshBtn" class="btn btn-primary w-full md:w-auto px-6 py-3 text-base font-semibold flex items-center justify-center gap-2">
          <i id="refreshIcon" class="fa-solid fa-rotate btn-icon transition-transform duration-300"></i>
          <span>دریافت کانفیگ جدید</span>
        </button>

        <div class="flex gap-6 items-center">
          <div class="text-center">
            <div class="text-2xl font-bold text-white" id="proxyCount">0</div>
            <div class="text-sm text-slate-400">کل کانفیگ‌ها</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-green-400" id="activeCount">0</div>
            <div class="text-sm text-slate-400">فعال</div>
          </div>
        </div>

        <button id="testVisibleBtn" class="btn btn-success w-full md:w-auto px-6 py-3 text-base font-semibold flex items-center justify-center gap-2">
          <i class="fa-solid fa-bolt-lightning btn-icon transition-transform duration-300"></i>
          <span>تست موارد نمایش‌ داده‌ شده</span>
        </button>
      </div>
    </div>
  </section>

  <div id="status" class="text-center mb-8 hidden">
    <div class="inline-flex items-center gap-3 text-slate-300">
      <div class="loading-spinner"></div>
      <span class="font-medium">در حال بارگذاری...</span>
    </div>
  </div>

  <div id="proxyList" class="proxy-grid"></div>

  <div id="loadMoreContainer" class="text-center mt-8 hidden">
    <button id="loadMoreBtn" class="btn px-8 py-3 text-base font-semibold">
      <i class="fa-solid fa-chevron-down mr-2 btn-icon"></i> نمایش بیشتر
    </button>
  </div>

  <div id="noResults" class="text-center py-16 hidden">
    <div class="proxy-card p-12 inline-block">
      <div class="card-content">
        <div class="w-24 h-24 bg-slate-800/60 rounded-full flex items-center justify-center mx-auto mb-6 border border-slate-700">
          <i class="fa-solid fa-ghost text-4xl text-slate-400"></i>
        </div>
        <h3 class="text-2xl font-bold text-white mb-3">کانفیگی یافت نشد!</h3>
        <p class="text-slate-400 mb-6">لطفاً لیست را بروزرسانی کنید یا بعداً تلاش کنید.</p>
        <button id="retryBtn" class="btn btn-primary px-6 py-3">
          <i class="fa-solid fa-rotate mr-2"></i> تلاش مجدد
        </button>
      </div>
    </div>
  </div>
</main>

<footer class="text-center py-8 mt-12 border-t border-gray-800 text-slate-400 fade-in-up" style="animation-delay:.4s;">
  <div class="container mx-auto px-4">
    <div class="grid md:grid-cols-2 gap-8 items-center">
      <div class="flex flex-col items-center md:items-start gap-3">
        <div class="flex items-center gap-3">
          <i class="fab fa-telegram text-2xl text-sky-400"></i>
          <h4 class="font-bold text-lg text-white">به کانال تلگرام ما بپیوندید</h4>
        </div>
        <p>برای دریافت آخرین کانفیگ‌ها و اطلاع از بروزرسانی‌ها، ما را دنبال کنید.</p>
        <a href="https://t.me/V2rayNG_Ghavi" target="_blank" rel="noopener" class="group inline-block mt-2 bg-sky-500/10 hover:bg-sky-500/20 text-sky-400 font-semibold py-2 px-5 border border-sky-500/20 rounded-lg transition-all">
          @V2rayNG_Ghavi <i class="fa-solid fa-arrow-up-right-from-square text-xs ml-1 opacity-70 group-hover:opacity-100"></i>
        </a>
      </div>
      <div class="flex flex-col items-center md:items-end gap-3">
        <div class="flex items-center gap-3">
          <i class="fa-solid fa-code text-xl text-green-400"></i>
          <h4 class="font-bold text-lg text-white">طراح و توسعه‌دهنده</h4>
        </div>
        <p>ساخته شده با <i class="fa-solid fa-heart text-red-500"></i> برای دسترسی آزاد</p>
        <a href="https://t.me/V2rayNG_Ghavi" target="_blank" rel="noopener" class="group inline-block mt-2 bg-green-500/10 hover:bg-green-500/20 text-green-400 font-semibold py-2 px-5 border border-green-500/20 rounded-lg transition-all">
          @V2rayNG_Ghavi
          <i class="fa-solid fa-arrow-up-right-from-square text-xs ml-1 opacity-70 group-hover:opacity-100"></i>
        </a>
      </div>
    </div>
    <div class="mt-8 pt-6 border-top border-gray-800/50 text-sm">
      <p class="flex items-center justify-center gap-x-2 flex-wrap">
        <span>&copy; 1403 V2rayNG_Ghavi. تمامی حقوق محفوظ است.</span>
        <span class="bg-sky-500/10 text-sky-400 text-xs font-semibold px-2.5 py-0.5 rounded-full border border-sky-500/20">نسخه 1.2</span>
      </p>
    </div>
  </div>
</footer>

<script>
  // افکت گلو برای کارت‌ها
  document.addEventListener('mousemove', e=>{
    const cards=document.querySelectorAll('.proxy-card');
    cards.forEach(card=>{
      const r=card.getBoundingClientRect();
      card.style.setProperty('--mouse-x',`${e.clientX-r.left}px`);
      card.style.setProperty('--mouse-y',`${e.clientY-r.top}px`);
    });
  },{passive:true});

  // وضعیت‌ها
  let allProxies=[];          // همه کانفیگ‌ها
  let visibleCount=9;         // تعداد آیتم‌های قابل‌نمایش فعلی
  const perPage=9;            // مقدار افزایش با «نمایش بیشتر»
  let isLoading=false;

  const elements={
    refreshBtn:document.getElementById('refreshBtn'),
    testVisibleBtn:document.getElementById('testVisibleBtn'),
    refreshIcon:document.getElementById('refreshIcon'),
    proxyCount:document.getElementById('proxyCount'),
    activeCount:document.getElementById('activeCount'),
    status:document.getElementById('status'),
    proxyList:document.getElementById('proxyList'),
    noResults:document.getElementById('noResults'),
    loadMoreContainer:document.getElementById('loadMoreContainer'),
    loadMoreBtn:document.getElementById('loadMoreBtn'),
    retryBtn:document.getElementById('retryBtn')
  };

  // ترجمه چند کشور معروف (بقیه با ایموجی + انگلیسی)
  const countryTranslations={
    'Russia':'🇷🇺 روسیه','Netherlands':'🇳🇱 هلند','United States':'🇺🇸 آمریکا',
    'Germany':'🇩🇪 آلمان','France':'🇫🇷 فرانسه','United Kingdom':'🇬🇧 انگلستان',
    'Canada':'🇨🇦 کانادا','Italy':'🇮🇹 ایتالیا','Spain':'🇪🇸 اسپانیا','Turkey':'🇹🇷 ترکیه',
    'Finland':'🇫🇮 فنلاند','Sweden':'🇸🇪 سوئد','Poland':'🇵🇱 لهستان','Iran':'🇮🇷 ایران'
  };

  const getVisibleSlice=()=> allProxies.slice(0, Math.min(visibleCount, allProxies.length));

  const setLoadingState=(b)=>{
    isLoading=b;
    elements.refreshBtn.disabled=b;
    elements.testVisibleBtn.disabled=b;
    elements.status.classList.toggle('hidden',!b);
    elements.refreshIcon.classList.toggle('fa-spin',b);
  };

  const showToast=(msg,type='info')=>{
    const el=document.createElement('div');
    el.className=`fixed bottom-6 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg
                  ${type==='success'?'bg-green-600':type==='danger'?'bg-red-600':type==='warning'?'bg-yellow-600':'bg-blue-600'}
                  text-white font-medium flex items-center gap-2 z-50`;
    el.innerHTML=`<i class="fa-solid ${type==='success'?'fa-check-circle':type==='danger'?'fa-times-circle':type==='warning'?'fa-triangle-exclamation':'fa-info-circle'}"></i><span>${msg}</span>`;
    document.body.appendChild(el);
    setTimeout(()=>{el.classList.add('opacity-0','transition-opacity','duration-300');setTimeout(()=>el.remove(),300)},3000);
  };

  // --- Country helpers ---
  function countryFlag(countryCode){
    if(!countryCode) return '🌐';
    try{
      return countryCode.toUpperCase().replace(/./g, char =>
        String.fromCodePoint(127397 + char.charCodeAt(0))
      );
    }catch{
      return '🌐';
    }
  }

  function flagAndNameFromData(countryCode, countryName){
    if(countryCode && countryName){
      const flag = countryFlag(countryCode);
      return `${flag} ${countryName}`;
    }
    return '🌐 نامشخص';
  }

  function flagEmojiFromCode(code){
    if(!code||code.length!==2) return '🌐';
    const base=127397;
    return String.fromCodePoint(code[0].toUpperCase().charCodeAt(0)+base)+String.fromCodePoint(code[1].toUpperCase().charCodeAt(0)+base);
  }

  function isIpAddress(host){ return /^\d{1,3}(\.\d{1,3}){3}$/.test(host); }
  function safeAtob(str){
    try{
      const pad=str.length%4; let s=str;
      if(pad) s+='='.repeat(4-pad);
      s=s.replace(/-/g,'+').replace(/_/g,'/');
      return atob(s);
    }catch{ return ''; }
  }
  function parseVmessHost(link){
    try{
      const b64=link.slice('vmess://'.length).trim();
      const json=safeAtob(b64); if(!json) return null;
      const obj=JSON.parse(json);
      return obj.add||obj.host||obj.sni||null;
    }catch{ return null; }
  }
  function parseVlessHost(link){
    try{
      const after=link.slice('vless://'.length);
      const at=after.indexOf('@'); if(at===-1) return null;
      const afterAt=after.slice(at+1);
      const colon=afterAt.indexOf(':');
      const host=colon===-1?afterAt:afterAt.slice(0,colon);
      return host||null;
    }catch{ return null; }
  }
  function extractHostFromLink(link){
    if(link.startsWith('vmess://')) return parseVmessHost(link);
    if(link.startsWith('vless://')) return parseVlessHost(link);
    return null;
  }
  function formatCountryLabel(english, code){
    if(english && countryTranslations[english]) return countryTranslations[english];
    const flag=flagEmojiFromCode(code||'');
    return `${flag} ${english||'نامشخص'}`;
  }

  // استفاده از ipapi.co برای گرفتن کشور از IP یا دامنه
  // نمونه: https://ipapi.co/8.8.8.8/json/ یا https://ipapi.co/google.com/json/
  async function getCountryInfoFromIpapi(hostOrIp){
    try{
      // ipapi اجازه استفاده از دامنه یا آی‌پی را می‌دهد؛ در بعضی موارد ممکن است محدودیت داشته باشد.
      const url = `https://ipapi.co/${encodeURIComponent(hostOrIp)}/json/`;
      const res = await fetch(url, {cache:'no-store'});
      if(!res.ok) throw new Error('ipapi response not ok');
      const data = await res.json();
      // data.country (ex: "US"), data.country_name (ex: "United States")
      if(data && data.country && data.country_name){
        return {code: data.country, name: data.country_name};
      }
      return null;
    }catch(err){
      // اگر ipapi خطا داد، فقط null برگردان
      console.warn('ipapi error for', hostOrIp, err);
      return null;
    }
  }

  // فقط کشور برای آیتم‌های قابل‌نمایش را resolve می‌کنیم
  let resolvingSet=new Set(); // جلوگیری از تکرار
  async function resolveCountryForProxy(proxy){
    if(resolvingSet.has(proxy.id) || proxy.countryResolved) return;
    resolvingSet.add(proxy.id);
    try{
      const host=extractHostFromLink(proxy.config);
      if(!host){ resolvingSet.delete(proxy.id); return; }
      let ipOrHost = host;
      // اگر دامین است سعی کن DNS lookup از گوگل بگیری
      if(!isIpAddress(host)){
        try{
          const ip = await resolveDomainToIP(host);
          if(ip) ipOrHost = ip;
        }catch{ /* ignore */ }
      }
      // حالا از ipapi استفاده کن (روی IP یا دامنه)
      let info = await getCountryInfoFromIpapi(ipOrHost);
      // اگر با IP جواب نگرفتیم، تلاش کن با خود دامنه (اگر قبلاً IP بود)
      if(!info && ipOrHost!==host){
        info = await getCountryInfoFromIpapi(host);
      }
      // اگر هنوز null، برگرد به geoIp قبلی (ipwho.is) به عنوان fallback
      if(!info){
        const geo = await geoIp(ipOrHost);
        if(geo) info = {code: geo.code, name: geo.name};
      }
      if(info){
        proxy.country = flagAndNameFromData(info.code, info.name);
        proxy.countryResolved=true;
        updateCountsOnly(); // سبک
        updateCardsOfVisibleOnly(); // سبک
      }
    }finally{
      resolvingSet.delete(proxy.id);
    }
  }

  async function resolveCountriesForVisible(){
    const vis=getVisibleSlice();
    for(const p of vis){
      // اگر هنوز مشخص نشده، تلاش کن
      if(!p.countryResolved) await resolveCountryForProxy(p);
      await new Promise(r=>setTimeout(r,150)); // کمی فاصله برای جلوگیری از ریت‌لیمیت
    }
  }

  async function resolveDomainToIP(host){
    try{
      const res=await fetch(`https://dns.google/resolve?name=${encodeURIComponent(host)}&type=A`,{cache:'no-store'});
      if(!res.ok) throw new Error('dns failed');
      const data=await res.json();
      const ans=(data.Answer||[]).find(x=>x.type===1);
      return ans?ans.data:null;
    }catch{ return null; }
  }
  async function geoIp(ip){
    try{
      const res=await fetch(`https://ipwho.is/${encodeURIComponent(ip)}`,{cache:'no-store'});
      if(!res.ok) throw new Error('geo failed');
      const data=await res.json();
      if(data && data.success){ return {name:data.country, code:data.country_code}; }
      return null;
    }catch{ return null; }
  }

  // لود لیست
  async function loadProxies(){
    if(isLoading) return;
    setLoadingState(true);
    try{
      const response=await fetch("https://gist.githubusercontent.com/Mahyar5803/180f4ad81481ea542c56e29de00898be/raw/19a43f181e9a9be46b7f0ebd44d4dbfcbc3c7a70/V2ray_Collector");
      if(!response.ok) throw new Error("خطا در دریافت پاسخ از سرور");
      const text=await response.text();
      const links=text.split('\n').map(s=>s.trim()).filter(s=>s.startsWith('vmess://')||s.startsWith('vless://'));
      allProxies=links.map((link,i)=>({id:i,config:link,country:'🌐 نامشخص',ping:null,status:'unknown',countryResolved:false}));
      visibleCount=perPage; // ریست
      showToast('✅ کانفیگ‌ها بارگذاری شدند.','success');
    }catch(e){
      console.error(e);
      allProxies=[];
      showToast('❌ خطا در دریافت کانفیگ‌ها.','danger');
    }finally{
      setLoadingState(false);
      updateUIFullRender();
      // resolve فقط برای قابل‌نمایش
      resolveCountriesForVisible();
    }
  }

  // تست فقط آیتم‌های نمایش‌داده‌شده
  async function testVisible(){
    if(isLoading) return;
    setLoadingState(true);
    showToast('در حال تست آیتم‌های نمایش‌ داده‌ شده...','info');

    const vis=getVisibleSlice();
    // به‌صورت ترتیبی برای جلوگیری از لگ UI
    for(let i=0;i<vis.length;i++){
      await testProxy(vis[i].id);
      await new Promise(r=>setTimeout(r,250));
    }

    // مرتب‌سازی کل لیست بر اساس پینگ (آیتم‌هایی که پینگ ندارند به انتها)
    allProxies.sort((a,b)=>{
      const pa = (a.ping==null)?Infinity:a.ping;
      const pb = (b.ping==null)?Infinity:b.ping;
      return pa - pb;
    });

    // بعد از مرتب‌سازی، برای نمایش پرچم‌های آیتم‌های جدید قابل‌نمایش تلاش کن (در صورت لزوم)
    await resolveCountriesForVisible();

    setLoadingState(false);
    updateUIFullRender();
    showToast('تست موارد نمایش‌ داده‌ شده کامل شد و لیست بر اساس پینگ مرتب شد.','success');
  }

  // تست تکی
  async function testProxy(id){
    const proxy=allProxies.find(p=>p.id===id);
    if(!proxy) return;
    proxy.status='unknown';
    updateCardIfVisible(id);

    // شبیه‌سازی پینگ سبک — اگر خواستی اینجا میشه با روش واقعی‌تر جایگزین کرد
    const ping=Math.floor(Math.random()*300)+50;
    proxy.ping=ping;
    proxy.status = ping<150 ? 'good' : ping<300 ? 'medium' : 'bad';

    updateCardIfVisible(id);
  }

  // UI helpers
  function updateCountsOnly(){
    elements.proxyCount.textContent=allProxies.length;
    const active=allProxies.filter(p=>p.status==='good').length;
    elements.activeCount.textContent=active;
  }

  function updateUIFullRender(){
    updateCountsOnly();
    if(allProxies.length===0){
      elements.noResults.classList.remove('hidden');
      elements.proxyList.innerHTML='';
      elements.loadMoreContainer.classList.add('hidden');
      return;
    }
    elements.noResults.classList.add('hidden');
    renderVisibleCards();
    elements.loadMoreContainer.classList.toggle('hidden', visibleCount>=allProxies.length);
  }

  function updateCardsOfVisibleOnly(){
    // بدون پاک‌کردن کل لیست، فقط کارت‌های موجود را به‌روزرسانی کن
    const vis=getVisibleSlice();
    for(const p of vis){
      updateCardIfVisible(p.id,true);
    }
  }

  function renderVisibleCards(){
    const vis=getVisibleSlice();
    // برای جلوگیری از پرش صفحه، از DocumentFragment استفاده می‌کنیم
    const frag=document.createDocumentFragment();
    for(const proxy of vis){
      let card=document.getElementById(`card-${proxy.id}`);
      const html=getCardHTML(proxy);
      if(card){
        // به‌روزرسانی نرم
        card.querySelector('.card-content').innerHTML = html;
        attachCardHandlers(card, proxy.id);
      }else{
        // ایجاد کارت جدید
        const wrapper=document.createElement('div');
        wrapper.className='proxy-card fade-in-up';
        wrapper.id=`card-${proxy.id}`;
        wrapper.innerHTML=`<div class="card-content">${html}</div>`;
        frag.appendChild(wrapper);
        attachCardHandlers(wrapper, proxy.id);
      }
    }
    // حذف کارت‌های اضافی (اگر قبلاً بیشتر بوده)
    const currentCards=[...elements.proxyList.children];
    for(const c of currentCards){
      const id=parseInt(c.id.replace('card-',''),10);
      if(!vis.find(p=>p.id===id)) c.remove();
    }
    elements.proxyList.appendChild(frag);
  }

  function updateCardIfVisible(id, soft=false){
    const card=document.getElementById(`card-${id}`);
    if(!card) return;
    const p=allProxies.find(x=>x.id===id);
    const html=getCardHTML(p);
    if(soft){
      // فقط بخش‌های داده‌ای را به‌روزرسانی کن
      card.querySelector('.card-content').innerHTML = html;
      attachCardHandlers(card, id);
    }else{
      card.querySelector('.card-content').innerHTML = html;
      attachCardHandlers(card, id);
    }
  }

  function attachCardHandlers(scope, id){
    const testBtn=scope.querySelector(`[data-test="${id}"]`);
    const copyBtn=scope.querySelector(`[data-copy="${id}"]`);
    if(testBtn) testBtn.onclick=()=>testProxy(id);
    if(copyBtn) copyBtn.onclick=()=>copyToClipboard(allProxies.find(p=>p.id===id)?.config||'');
  }

  function statusBadge(proxy){
    const s=proxy.status;
    if(s==='good') return {cls:'status-good',dot:'bg-green-500 pulsing-dot',txt:'عالی'};
    if(s==='medium') return {cls:'status-medium',dot:'bg-yellow-500',txt:'متوسط'};
    if(s==='bad') return {cls:'status-bad',dot:'bg-red-500',txt:'ضعیف'};
    return {cls:'status-unknown',dot:'bg-slate-500',txt:'نامشخص'};
  }

  function getCardHTML(proxy){
    const st=statusBadge(proxy);
    return `
      <div class="flex justify-between items-start mb-4">
        <h3 class="font-bold text-lg truncate">کانفیگ #${proxy.id+1}</h3>
        <span class="status-badge ${st.cls}">
          <span class="w-2 h-2 rounded-full ${st.dot}"></span>
          ${st.txt}
        </span>
      </div>
      <div class="space-y-3 mb-6">
        <div class="flex justify-between">
          <span class="text-slate-400">کشور:</span>
          <span class="font-medium">${proxy.country || '🌐 نامشخص'}</span>
        </div>
        ${proxy.ping!==null?
        `<div class="flex justify-between">
          <span class="text-slate-400">پینگ:</span>
          <span class="font-medium">${proxy.ping} ms</span>
        </div>`:''}
      </div>
      <div class="flex gap-3">
        <button data-test="${proxy.id}" class="btn flex-1 py-2">
          <i class="fa-solid fa-bolt-lightning ml-2"></i> تست سرعت
        </button>
        <button data-copy="${proxy.id}" class="btn btn-primary flex-1 py-2">
          <i class="fa-solid fa-copy ml-2"></i> کپی
        </button>
      </div>
    `;
  }

  function copyToClipboard(text){
    navigator.clipboard.writeText(text)
      .then(()=>showToast('کانفیگ کپی شد!','success'))
      .catch(()=>showToast('خطا در کپی کردن','danger'));
  }

  // نمایش بیشتر
  function loadMore(){
    const prev=visibleCount;
    visibleCount=Math.min(visibleCount+perPage, allProxies.length);
    // رندر نرم (بدون پرش)
    renderVisibleCards();
    elements.loadMoreContainer.classList.toggle('hidden', visibleCount>=allProxies.length);
    // فقط کشورهای سری جدید را resolve کن
    const newlyVisible=allProxies.slice(prev, visibleCount);
    (async()=>{
      for(const p of newlyVisible){
        await resolveCountryForProxy(p);
        await new Promise(r=>setTimeout(r,150));
      }
    })();
  }

  // رویدادها
  elements.refreshBtn.addEventListener('click', loadProxies);
  elements.testVisibleBtn.addEventListener('click', testVisible);
  elements.loadMoreBtn.addEventListener('click', loadMore);
  elements.retryBtn.addEventListener('click', loadProxies);
  document.getElementById('closeWelcomeModal').addEventListener('click',()=>{
    document.getElementById('welcomeModal').classList.add('hidden');
    localStorage.setItem('welcomeModalShown','true');
  });

  // نمایش خوش‌آمدگویی
  if(!localStorage.getItem('welcomeModalShown')){
    setTimeout(()=>document.getElementById('welcomeModal').classList.remove('hidden'),1000);
  }

  // شمارنده‌ها و شروع
  function initCounts(){ elements.proxyCount.textContent='0'; elements.activeCount.textContent='0'; }
  initCounts();
  loadProxies();
</script>
</body>
</html>
